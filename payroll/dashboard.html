<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #4E95D9;
      --sidebar-bg: #2C3E50;
      --secondary-color: #FFCCCC;
      --accent-bg: #F7F9FB;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --bg-light: #FFFFFF;
      --bg-dark: #1F2A3C;
      --text-light: #34495E;
      --text-dark: #DDE4EB;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-light);
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
    }

    body.dark-mode {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    .container-fluid {
      padding: 0;
      height: 100vh;
      overflow-x: hidden;
    }

    .sidebar {
      background-color: var(--sidebar-bg);
      color: var(--text-dark);
      padding: 20px 10px;
      position: fixed;
      height: 100%;
      width: 250px;
      transform: translateX(0);
      transition: var(--transition);
      z-index: 1000;
    }

    .sidebar h5 {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar a {
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      text-decoration: none;
      border-radius: 8px;
      margin: 5px 10px;
      transition: var(--transition);
    }

    .sidebar a.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--primary-color);
      font-weight: 600;
    }

    .sidebar a:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .sidebar .nav-item {
      margin-bottom: 10px;
    }

    .sidebar .collapse {
      padding-left: 20px;
    }

    .header {
      background-color: var(--accent-bg);
      padding: 15px 20px;
      border-bottom: 1px solid #e6ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
    }

    body.dark-mode .header {
      background-color: #34495e;
      border-bottom: 1px solid #4b627a;
    }

    .header .search-bar {
      max-width: 300px;
      position: relative;
    }

    .header .search-bar .form-control {
      padding-right: 3.5rem;
      border-radius: 20px;
      font-size: 0.9rem;
      border: 1px solid #dee2e6;
      transition: var(--transition);
    }

    .header .search-bar .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(78, 149, 217, 0.25);
      background-color: white;
    }

    .header .search-bar .search-icon {
      position: absolute;
      right: 30px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary-color);
      cursor: pointer;
    }

    .header .search-bar .clear-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary-color);
      cursor: pointer;
    }

    .header .file-import {
      max-width: 200px;
      position: relative;
    }

    .header .file-import input[type="file"] {
      font-size: 0.9rem;
      border-radius: 20px;
    }

    .header .file-import .import-loader {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    .profile-section {
      position: relative;
      cursor: pointer;
    }

    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary-color);
    }

    .dropdown-menu {
      right: 0;
      left: auto;
      background-color: var(--accent-bg);
    }

    body.dark-mode .dropdown-menu {
      background-color: #34495e;
    }

    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: var(--transition);
      background-color: var(--bg-light);
      min-height: 100vh;
    }

    body.dark-mode .main-content {
      background-color: var(--bg-dark);
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      cursor: pointer;
      background-color: var(--accent-bg);
    }

    body.dark-mode .card {
      background-color: #34495e;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .card-body {
      padding: 1.5rem;
    }

    .card-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: var(--secondary-color);
    }

    .loader {
      border: 4px solid #e0e6eb;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .theme-toggle {
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--primary-color);
    }

    /* Flatpickr Styles */
    .flatpickr-calendar {
      background: var(--accent-bg);
      box-shadow: var(--card-shadow);
      border-radius: 8px;
    }

    body.dark-mode .flatpickr-calendar {
      background: #34495e;
      color: var(--text-dark);
    }

    .flatpickr-monthDropdown-months,
    .flatpickr-current-month .flatpickr-monthDropdown-month,
    .flatpickr-current-month input.cur-year {
      color: var(--text-light);
    }

    body.dark-mode .flatpickr-monthDropdown-months,
    body.dark-mode .flatpickr-current-month .flatpickr-monthDropdown-month,
    body.dark-mode .flatpickr-current-month input.cur-year {
      color: var(--text-dark);
    }

    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange,
    .flatpickr-day.selected:hover,
    .flatpickr-day.startRange:hover,
    .flatpickr-day.endRange:hover {
      background: var(--primary-color);
      color: var(--text-dark);
      border-color: var(--primary-color);
    }

    .flatpickr-day.today {
      border-color: var(--primary-color);
    }

    .flatpickr-day:hover {
      background: #E6ECEF;
    }

    body.dark-mode .flatpickr-day:hover {
      background: #4b627a;
    }

    @media (max-width: 991px) {
      .sidebar {
        transform: translateX(-100%);
        width: 80%;
        max-width: 250px;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .header .search-bar {
        max-width: 200px;
      }

      .header .file-import {
        max-width: 150px;
      }
    }

    @media (max-width: 767px) {
      .card {
        margin-bottom: 1rem;
      }

      .header {
        padding: 10px 15px;
      }

      .header .search-bar {
        max-width: 150px;
      }

      .header .file-import {
        max-width: 120px;
      }

      .flatpickr-input {
        font-size: 0.85rem;
        padding: 6px 16px;
      }
    }

    @media (max-width: 575px) {
      .header span {
        font-size: 0.9rem;
      }

      .profile-img {
        width: 32px;
        height: 32px;
      }

      .card-body {
        padding: 1rem;
      }

      .card-icon {
        font-size: 1.5rem;
      }

      .flatpickr-input {
        width: 100%;
      }

      .header .file-import {
        max-width: 100%;
      }
    }

    .menu-toggle {
      display: none;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px 10px;
      color: var(--primary-color);
    }

    @media (max-width: 991px) {
      .menu-toggle {
        display: block;
      }
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 sidebar">
      <h5 class="text-center">LAMINCAP <span style="color: var(--primary-color);">X</span> PAYROLL</h5>
      <div class="nav-item">
        <a href="dashboard.html" class="active" >
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        
      </div>
      <div class="nav-item">
        <a href="teachingstaff.html" data-bs-toggle="collapse" data-bs-target="#teaching-menu">
          <i class="fas fa-chalkboard-teacher"></i> Teaching Staff
        </a>
        <div id="teaching-menu" class="collapse">
          <a href="teachingstaff.html">Staff List</a>
          <a href="teaching-payroll.html">Payroll</a>
        </div>
      </div>
      <div class="nav-item">
        <a href="nonteachingstaff.html" data-bs-toggle="collapse" data-bs-target="#nonteaching-menu">
          <i class="fas fa-user-tie"></i> Non-Teaching Staff
        </a>
        <div id="nonteaching-menu" class="collapse">
          <a href="nonteachingstaff.html">Staff List</a>
          <a href="non-teaching-payroll.html">Payroll</a>
        </div>
      </div>
            <div class="nav-item">
        <a href="payslip.html">
          <i class="fas fa-file-invoice"></i> Payslip
        </a>
</div>
    </div>

    <div class="col-md-10 main-content">
      <div class="header">
        <div class="d-flex align-items-center gap-2">
          <button class="menu-toggle"><i class="fas fa-bars"></i></button>
          <span>Hello, Admin ðŸ‘‹</span>
        </div>
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <div class="search-bar position-relative">
            <input type="text" class="form-control" placeholder="Search by employee type..." id="search-input" />
            <i class="fas fa-search search-icon" id="search-button"></i>
            <i class="fas fa-times clear-icon" id="clear-search" style="display: none;"></i>
          </div>
          <div class="file-import position-relative">
            <input type="file" class="form-control" id="file-import" accept=".csv,.xlsx" title="Import employee data" />
            <div class="import-loader" style="display: none;">
              <div class="loader"></div>
            </div>
          </div>
          <i class="fas fa-bell theme-toggle" title="Notifications"></i>
          <i class="fas fa-moon theme-toggle" id="theme-toggle" title="Toggle Theme"></i>
          <div class="profile-section" data-bs-toggle="dropdown">
            <span>Admin Name</span>
            <img src="https://randomuser.me/api/portraits/women/44.jpg" class="profile-img" alt="Profile" />
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" id="profile-link"><i class="fas fa-user"></i> Profile</a></li>
              <li><a class="dropdown-item" href="#" id="settings-link"><i class="fas fa-cog"></i> Settings</a></li>
              <li><a class="dropdown-item" href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="p-4">
        <div class="row g-3">
          <div class="col-md-4 col-sm-6">
            <div class="card shadow-sm text-center" data-type="teaching">
              <div class="card-body">
                <h6 class="card-title">Teaching Staff Count</h6>
                <div class="card-icon"><i class="fas fa-chalkboard-teacher"></i></div>
                <h4 style="color: var(--primary-color);" id="teaching-count">Loading...</h4>
              </div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card shadow-sm text-center" data-type="nonteaching">
              <div class="card-body">
                <h6 class="card-title">Non-Teaching Staff Count</h6>
                <div class="card-icon"><i class="fas fa-user-tie"></i></div>
                <h4 style="color: var(--primary-color);" id="non-teaching-count">Loading...</h4>
              </div>
            </div>
          </div>
          <div class="col-md-4 d-flex justify-content-center align-items-center">
            <canvas id="staffPieChart"></canvas>
          </div>
        </div>

        <div class="row mt-4 g-3">
          <div class="col-md-6 col-sm-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <h6>Current Month Salaries Total</h6>
                <h5 style="color: var(--primary-color);" id="current-salary">Loading...</h5>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-sm-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <h6>Last Month Salaries Total</h6>
                <h5 style="color: var(--primary-color);" id="last-salary">Loading...</h5>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-4 shadow-sm">
          <div class="card-body">
            <h6>Last 5 Months Salary Trend</h6>
            <input type="text" id="chartFilter" class="form-control mb-3" style="max-width: 200px;" placeholder="Select Month/Year">
            <canvas id="salaryBarChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Helper function to get employees from localStorage
  function getEmployees(type) {
    try {
      const data = JSON.parse(localStorage.getItem(type) || '[]');
      return Array.isArray(data) ? data : [];
    } catch (error) {
      console.error(`Error reading ${type} from localStorage:`, error);
      return [];
    }
  }

  // Helper function to save employees to localStorage
  function saveEmployees(type, employees) {
    try {
      localStorage.setItem(type, JSON.stringify(employees));
    } catch (error) {
      console.error(`Error saving ${type} to localStorage:`, error);
    }
  }

  // Parse CSV or Excel file and import data
  function importFile(file) {
    const fileExt = file.name.split('.').pop().toLowerCase();
    if (fileExt === 'csv') {
      Papa.parse(file, {
        complete: (result) => {
          try {
            const rows = result.data;
            if (rows.length < 1) {
              alert('Empty CSV file');
              return;
            }
            processRows(rows);
          } catch (error) {
            console.error('Error parsing CSV:', error);
            alert('Failed to import CSV. Please check the file format.');
          }
        },
        header: false,
        skipEmptyLines: true
      });
    } else if (fileExt === 'xlsx') {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          if (rows.length < 1) {
            alert('Empty Excel file');
            return;
          }
          processRows(rows);
        } catch (error) {
          console.error('Error parsing Excel:', error);
          alert('Failed to import Excel. Please check the file format.');
        }
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert('Please select a CSV or Excel file');
      return;
    }

    function processRows(rows) {
      const headers = rows[0].map(h => h.trim().toLowerCase());
      const requiredHeaders = ['id', 'name', 'department', 'salary', 'hiredate', 'type'];
      if (!requiredHeaders.every(h => headers.includes(h))) {
        alert('Invalid file format. Required headers: id, name, department, salary, hireDate, type');
        return;
      }

      const teachingEmployees = getEmployees('teachingEmployees');
      const nonTeachingEmployees = getEmployees('nonTeachingEmployees');
      const teachingIds = new Set(teachingEmployees.map(emp => emp.id));
      const nonTeachingIds = new Set(nonTeachingEmployees.map(emp => emp.id));

      const newTeaching = [];
      const newNonTeaching = [];

      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i];
        if (cols.length < headers.length) continue;

        const employee = {};
        headers.forEach((header, index) => {
          employee[header] = cols[index] ? cols[index].toString().trim() : '';
        });

        if (!employee.id || !employee.name || !employee.department || !employee.salary || !employee.hiredate || !employee.type) {
          console.warn(`Skipping invalid row ${i}:`, employee);
          continue;
        }

        if (isNaN(employee.salary) || Number(employee.salary) <= 0) {
          console.warn(`Invalid salary in row ${i}:`, employee.salary);
          continue;
        }
        if (!/^\d{4}-\d{2}-\d{2}$/.test(employee.hiredate)) {
          console.warn(`Invalid hireDate in row ${i}:`, employee.hiredate);
          continue;
        }

        const empData = {
          id: employee.id,
          name: employee.name,
          department: employee.department,
          salary: Number(employee.salary),
          hireDate: employee.hiredate,
          profilePic: employee.profilepic || ''
        };

        if (employee.type.toLowerCase() === 'teaching') {
          if (!teachingIds.has(empData.id)) {
            newTeaching.push(empData);
            teachingIds.add(empData.id);
          } else {
            const index = teachingEmployees.findIndex(emp => emp.id === empData.id);
            teachingEmployees[index] = empData;
          }
        } else if (employee.type.toLowerCase() === 'nonteaching') {
          if (!nonTeachingIds.has(empData.id)) {
            newNonTeaching.push(empData);
            nonTeachingIds.add(empData.id);
          } else {
            const index = nonTeachingEmployees.findIndex(emp => emp.id === empData.id);
            nonTeachingEmployees[index] = empData;
          }
        }
      }

      saveEmployees('teachingEmployees', [...teachingEmployees, ...newTeaching]);
      saveEmployees('nonTeachingEmployees', [...nonTeachingEmployees, ...newNonTeaching]);

      const searchTerm = document.getElementById('search-input').value.trim();
      fetchDashboardData(searchTerm);
      renderCharts(null, searchTerm);
      alert('Data imported successfully');
    }
  }

  // Filter employees by search term
  function filterEmployees(employees, searchTerm) {
    if (!searchTerm) return employees;
    return employees.filter(emp =>
      emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      emp.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
      emp.department.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }

  // Helper function to calculate salary trend for last 5 months
  function calculateSalaryTrend(teachingEmployees, nonTeachingEmployees, filterMonth = null, searchTerm = '') {
    const months = [];
    const teachingSalaries = [];
    const nonTeachingSalaries = [];
    const today = filterMonth ? new Date(filterMonth + '-01') : new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // Filter employees by search term
    const filteredTeaching = filterEmployees(teachingEmployees, searchTerm);
    const filteredNonTeaching = filterEmployees(nonTeachingEmployees, searchTerm);

    for (let i = 4; i >= 0; i--) {
      const date = new Date(currentYear, currentMonth - i, 1);
      const monthStr = date.toLocaleString('en-US', { month: 'short' });
      const yearStr = date.getFullYear().toString().slice(-2);
      months.push(`${monthStr}, ${yearStr}`);

      // Calculate total salaries for employees hired on or before the month
      const teachingTotal = filteredTeaching.reduce((sum, emp) => {
        const hireDate = new Date(emp.hireDate);
        if (hireDate <= date) return sum + (Number(emp.salary) || 0);
        return sum;
      }, 0);

      const nonTeachingTotal = filteredNonTeaching.reduce((sum, emp) => {
        const hireDate = new Date(emp.hireDate);
        if (hireDate <= date) return sum + (Number(emp.salary) || 0);
        return sum;
      }, 0);

      teachingSalaries.push(teachingTotal);
      nonTeachingSalaries.push(nonTeachingTotal);
    }

    return { months, teachingSalaries, nonTeachingSalaries };
  }

  function showLoading() {
    document.querySelectorAll('.card-body h4, .card-body h5').forEach(el => {
      el.innerHTML = '<div class="loader"></div>';
    });
  }

  async function fetchDashboardData(searchTerm = '') {
    showLoading();
    try {
      const teachingEmployees = getEmployees('teachingEmployees');
      const nonTeachingEmployees = getEmployees('nonTeachingEmployees');

      // Filter employees by search term
      const filteredTeaching = filterEmployees(teachingEmployees, searchTerm);
      const filteredNonTeaching = filterEmployees(nonTeachingEmployees, searchTerm);

      // Staff counts
      const staffData = {
        teaching: filteredTeaching.length,
        nonTeaching: filteredNonTeaching.length
      };
      document.getElementById('teaching-count').textContent = staffData.teaching;
      document.getElementById('non-teaching-count').textContent = staffData.nonTeaching;

      // Current and last month salaries
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);

      const currentSalary = filteredTeaching.reduce((sum, emp) => {
        const hireDate = new Date(emp.hireDate);
        return hireDate <= today ? sum + (Number(emp.salary) || 0) : sum;
      }, 0) + filteredNonTeaching.reduce((sum, emp) => {
        const hireDate = new Date(emp.hireDate);
        return hireDate <= today ? sum + (Number(emp.salary) || 0) : sum;
      }, 0);

      const lastSalary = filteredTeaching.reduce((sum, emp) => {
        const hireDate = new Date(emp.hireDate);
        return hireDate <= lastMonthDate ? sum + (Number(emp.salary) || 0) : sum;
      }, 0) + filteredNonTeaching.reduce((sum, emp) => {
        const hireDate = new Date(emp.hireDate);
        return hireDate <= lastMonthDate ? sum + (Number(emp.salary) || 0) : sum;
      }, 0);

      document.getElementById('current-salary').textContent = currentSalary ? `â‚¹ ${currentSalary.toLocaleString('en-IN')}` : 'â‚¹ 0';
      document.getElementById('last-salary').textContent = lastSalary ? `â‚¹ ${lastSalary.toLocaleString('en-IN')}` : 'â‚¹ 0';
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
      document.querySelectorAll('.card-body h4, .card-body h5').forEach(el => {
        el.textContent = 'Error loading data';
      });
    }
  }

  let pieChart, barChart;
  async function renderCharts(filterMonth = null, searchTerm = '') {
    try {
      const pieCanvas = document.getElementById('staffPieChart');
      const barCanvas = document.getElementById('salaryBarChart');
      if (!pieCanvas || !barCanvas) {
        console.error('Canvas elements not found:', { pieCanvas, barCanvas });
        return;
      }

      const teachingEmployees = getEmployees('teachingEmployees');
      const nonTeachingEmployees = getEmployees('nonTeachingEmployees');
      const filteredTeaching = filterEmployees(teachingEmployees, searchTerm);
      const filteredNonTeaching = filterEmployees(nonTeachingEmployees, searchTerm);
      const trendData = calculateSalaryTrend(teachingEmployees, nonTeachingEmployees, filterMonth, searchTerm);
      const staffData = {
        teaching: filteredTeaching.length,
        nonTeaching: filteredNonTeaching.length
      };

      const rootStyles = getComputedStyle(document.documentElement);
      const primaryColor = rootStyles.getPropertyValue('--primary-color').trim();
      const secondaryColor = rootStyles.getPropertyValue('--secondary-color').trim();

      if (pieChart && typeof pieChart.destroy === 'function') {
        pieChart.destroy();
      }
      if (barChart && typeof barChart.destroy === 'function') {
        barChart.destroy();
      }

      pieChart = new Chart(pieCanvas, {
        type: 'pie',
        data: {
          labels: ['Teaching Staff', 'Non-Teaching Staff'],
          datasets: [{
            data: [staffData.teaching, staffData.nonTeaching],
            backgroundColor: [primaryColor, secondaryColor]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
          },
          animation: {
            animateScale: true,
            animateRotate: true
          }
        }
      });

      barChart = new Chart(barCanvas, {
        type: 'bar',
        data: {
          labels: trendData.months || [],
          datasets: [
            {
              label: 'Teaching Staff',
              data: trendData.teachingSalaries || [],
              backgroundColor: primaryColor
            },
            {
              label: 'Non-Teaching Staff',
              data: trendData.nonTeachingSalaries || [],
              backgroundColor: secondaryColor
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { 
              beginAtZero: true, 
              title: { display: true, text: 'Salary (â‚¹)' },
              ticks: {
                callback: function(value) {
                  return 'â‚¹' + value.toLocaleString('en-IN');
                }
              }
            }
          },
          plugins: {
            tooltip: { 
              enabled: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += 'â‚¹' + (context.parsed.y || 0).toLocaleString('en-IN');
                  return label;
                }
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuad'
          }
        }
      });
    } catch (error) {
      console.error('Error rendering charts:', error);
    }
  }

  // Initialize Flatpickr
  function initializeDatePicker() {
    flatpickr('#chartFilter', {
      dateFormat: 'Y-m',
      altInput: true,
      altFormat: 'F Y',
      mode: 'single',
      static: true,
      onChange: (selectedDates, dateStr) => {
        const searchTerm = document.getElementById('search-input').value.trim();
        renderCharts(dateStr, searchTerm);
      }
    });
  }

  // Search functionality with debounce
  let debounceTimeout;
  function handleSearch() {
    const searchTerm = document.getElementById('search-input').value.trim();
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      fetchDashboardData(searchTerm);
      renderCharts(null, searchTerm);
    }, 300);
  }

  document.getElementById('search-button').addEventListener('click', handleSearch);
  document.getElementById('search-input').addEventListener('input', (e) => {
    document.getElementById('clear-search').style.display = e.target.value ? 'block' : 'none';
    handleSearch();
  });
  document.getElementById('search-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      handleSearch();
    }
  });

  document.getElementById('clear-search').addEventListener('click', () => {
    document.getElementById('search-input').value = '';
    document.getElementById('clear-search').style.display = 'none';
    fetchDashboardData('');
    renderCharts(null, '');
  });

  // File import event listener
  document.getElementById('file-import').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.name.match(/\.(csv|xlsx)$/)) {
      alert('Please select a CSV or Excel file');
      e.target.value = '';
      return;
    }
    document.querySelector('.import-loader').style.display = 'block';
    importFile(file);
    e.target.value = '';
    setTimeout(() => {
      document.querySelector('.import-loader').style.display = 'none';
    }, 1000);
  });

  document.querySelectorAll('.sidebar a').forEach(link => {
    link.addEventListener('click', (e) => {
      if (!link.getAttribute('data-bs-toggle')) {
        document.querySelector('.sidebar a.active')?.classList.remove('active');
        link.classList.add('active');
      }
    });
  });

  const menuToggle = document.querySelector('.menu-toggle');
  const sidebar = document.querySelector('.sidebar');
  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('active');
  });

  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 991 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
      sidebar.classList.remove('active');
    }
  });

  document.getElementById('profile-link').addEventListener('click', () => {
    alert('Navigating to Profile...');
  });
  document.getElementById('settings-link').addEventListener('click', () => {
    alert('Opening Settings...');
  });
  document.getElementById('logout-link').addEventListener('click', () => {
    alert('Logging out...');
  });

  document.querySelectorAll('.card[data-type]').forEach(card => {
    card.addEventListener('click', () => {
      const type = card.getAttribute('data-type');
      window.location.href = `${type}staff.html`;
    });
  });

  document.getElementById('theme-toggle').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const icon = document.getElementById('theme-toggle');
    icon.classList.toggle('fa-moon');
    icon.classList.toggle('fa-sun');
  });

  document.addEventListener('DOMContentLoaded', () => {
    fetchDashboardData();
    renderCharts();
    initializeDatePicker();
  });
</script>
</body>
</html>